package controllers

import (
	"github.com/gin-gonic/gin"
	"github.com/google/wire"
	"github.com/spf13/viper"
	"go.uber.org/zap"

	"{{ .Extra.pkgpath }}/internal"
	"{{ .Extra.pkgpath }}/internal/gen/models"
	"{{ .Extra.pkgpath }}/pkg/transports/http"
	"{{ .Extra.pkgpath }}/pkg/transports/http/middlewares/jwt"
	"{{ .Extra.pkgpath }}/pkg/transports/http/middlewares/permission"
)

type Controller struct {
	Logger    *zap.Logger
	ClaimsKey string
}

func NewController(v *viper.Viper, logger *zap.Logger) *Controller {
	claimsKey := v.GetString("jwt.ClaimsKey")

	return &Controller{
		Logger:    logger,
		ClaimsKey: claimsKey,
	}

}

func JsonError(c *gin.Context, code int, msg string) {
	c.AbortWithStatusJSON(200, gin.H{internal.RetCode: code, internal.RetMsg: msg})
}

func JsonData(c *gin.Context, data interface{}) {
    if data == nil {
	    c.JSON(200, gin.H{internal.RetCode: internal.RetCodeOK, internal.RetMsg: "success"})
    } else {
    	c.JSON(200, gin.H{internal.RetCode: internal.RetCodeOK, "data": data})
    }
}
func JsonPagination(c *gin.Context, list interface{}, total int64) {
	data := map[string]interface{}{
		"list":   list,
		"total":  total,
	}
	c.JSON(200, gin.H{internal.RetCode: internal.RetCodeOK, "data": data})
}

func HandleError(c *gin.Context, err error) bool {
	if err != nil {
		JsonError(c, internal.GetStatusCode(err), err.Error())
		return true
	}
	return false
}

func CreateInitControllersFn(
	logger *zap.Logger,
	jwt *jwt.GinJWT,
	perm *permission.GinPermission,
    {{- range .Tables}}
    {{.NameLowerCamel}} *{{.NameCamel}}Controller,
    {{- end}}
) http.BaseInitControllers {
	return func(r *gin.Engine) {
		apiv1 := r.Group("/api/v1")
		apiv1.Use(jwt.Middleware())
		apiv1.Use(perm.Middleware())
		{
            {{- range $table := .Tables}}
			{{- range .Methods}}
			{{- if eq . "list" }}
            apiv1.GET("/{{$table.NameSnakePlural}}", {{$table.NameLowerCamel}}.List)
			{{- end }}
			{{- if eq . "create" }}
            apiv1.POST("/{{$table.NameSnakePlural}}", {{$table.NameLowerCamel}}.Create)
			{{- end }}
			{{- if eq . "get" }}
            apiv1.GET("/{{$table.NameSnakePlural}}/:id", {{$table.NameLowerCamel}}.Get)
			{{- end }}
			{{- if eq . "update" }}
            apiv1.PATCH("/{{$table.NameSnakePlural}}", {{$table.NameLowerCamel}}.Update)
			{{- end }}
			{{- if eq . "delete" }}
            apiv1.DELETE("/{{$table.NameSnakePlural}}/:id", {{$table.NameLowerCamel}}.Delete)
			{{- end }}
			{{- if eq . "bulkGet" }}
            apiv1.POST("/{{$table.NameSnakePlural}}/bulkGet", {{$table.NameLowerCamel}}.BulkGet)
			{{- end }}
			{{- if eq . "bulkDelete" }}
            apiv1.POST("/{{$table.NameSnakePlural}}/bulkDelete", {{$table.NameLowerCamel}}.BulkDelete)
			{{- end }}
			{{- end }}
            {{- end }}
		}
	}
}

var BaseProviderSet = wire.NewSet(
	NewController,
    {{- range .Tables}}
    New{{.NameCamel}}Controller,
    {{- end}}
    CreateInitControllersFn,
)
